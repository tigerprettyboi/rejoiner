local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local player = Players.LocalPlayer

-- Configuration
local PLACE_ID = 103754275310547 -- PlaceId ของ Hunty Zombie
local WAIT_TIME = _G.time or 180   -- ใช้ _G.time ถ้ามี มิฉะนั้น 180 วินาที
local RETRY_DELAY = 3             -- เวลาก่อน retry (วินาที)

-- สร้าง GUI หลัก
local gui = Instance.new("ScreenGui")
gui.Name = "RejoinUI"
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = player:WaitForChild("PlayerGui")

-- Main frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 280, 0, 120)
mainFrame.Position = UDim2.new(1, -300, 0, 20)
mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = gui

-- สร้าง corner radius
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = mainFrame

-- สร้าง gradient background
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(35, 35, 45)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(20, 20, 25))
}
gradient.Rotation = 45
gradient.Parent = mainFrame

-- สร้าง stroke/border effect
local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(60, 60, 70)
stroke.Thickness = 1
stroke.Transparency = 0.5
stroke.Parent = mainFrame

-- Icon
local icon = Instance.new("ImageLabel")
icon.Size = UDim2.new(0, 24, 0, 24)
icon.Position = UDim2.new(0, 15, 0, 15)
icon.BackgroundTransparency = 1
icon.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png" -- หรือใช้ icon ที่ต้องการ
icon.ImageColor3 = Color3.fromRGB(100, 200, 255)
icon.Parent = mainFrame

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -50, 0, 25)
title.Position = UDim2.new(0, 45, 0, 15)
title.BackgroundTransparency = 1
title.Text = "Auto Rejoin"
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = mainFrame

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 18)
statusLabel.Position = UDim2.new(0, 10, 0, 42)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Next rejoin in:"
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12
statusLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
statusLabel.TextXAlignment = Enum.TextXAlignment.Center
statusLabel.Parent = mainFrame

-- Timer label
local timerLabel = Instance.new("TextLabel")
timerLabel.Size = UDim2.new(1, -20, 0, 35)
timerLabel.Position = UDim2.new(0, 10, 0, 60)
timerLabel.BackgroundTransparency = 1
timerLabel.Text = formatTime(WAIT_TIME) -- อัปเดตเริ่มต้นด้วยเวลาที่ถูกต้อง
timerLabel.Font = Enum.Font.GothamBlack
timerLabel.TextSize = 28
timerLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
timerLabel.TextXAlignment = Enum.TextXAlignment.Center
timerLabel.Parent = mainFrame

-- Progress bar background
local progressBg = Instance.new("Frame")
progressBg.Size = UDim2.new(1, -20, 0, 3)
progressBg.Position = UDim2.new(0, 10, 1, -15)
progressBg.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
progressBg.BorderSizePixel = 0
progressBg.Parent = mainFrame

local progressBgCorner = Instance.new("UICorner")
progressBgCorner.CornerRadius = UDim.new(0, 2)
progressBgCorner.Parent = progressBg

-- Progress bar fill
local progressFill = Instance.new("Frame")
progressFill.Size = UDim2.new(0, 0, 1, 0) -- เริ่มต้นที่ 0
progressFill.Position = UDim2.new(0, 0, 0, 0)
progressFill.BackgroundColor3 = Color3.fromRGB(100, 200, 255)
progressFill.BorderSizePixel = 0
progressFill.Parent = progressBg

local progressFillCorner = Instance.new("UICorner")
progressFillCorner.CornerRadius = UDim.new(0, 2)
progressFillCorner.Parent = progressFill

-- Close button
local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 20, 0, 20)
closeButton.Position = UDim2.new(1, -25, 0, 5)
closeButton.BackgroundTransparency = 1
closeButton.Text = "×"
closeButton.Font = Enum.Font.GothamBold
closeButton.TextSize = 16
closeButton.TextColor3 = Color3.fromRGB(200, 200, 200)
closeButton.Parent = mainFrame

-- ฟังก์ชันสร้าง animation
local function createTween(obj, info, properties)
    return TweenService:Create(obj, info, properties)
end

-- Animation เมื่อเริ่มต้น
local slideIn = createTween(mainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), 
    {Position = UDim2.new(1, -300, 0, 20)})
slideIn:Play()

-- ฟังก์ชันแปลงเวลาเป็น mm:ss
local function formatTime(sec)
    local m = math.floor(sec / 60)
    local s = sec % 60
    return string.format("%02d:%02d", m, s)
end

-- ฟังก์ชันอัปเดต progress bar
local function updateProgress(current, total)
    local progress = current / total
    createTween(progressFill, TweenInfo.new(0.2, Enum.EasingStyle.Quad), 
        {Size = UDim2.new(progress, 0, 1, 0)}):Play()
end

-- ฟังก์ชันเปลี่ยนสีตามเวลา
local function updateTimerColor(remaining, total)
    local ratio = remaining / total
    local color
    
    if ratio > 0.5 then
        color = Color3.fromRGB(100, 200, 255) -- ฟ้า
    elseif ratio > 0.25 then
        color = Color3.fromRGB(255, 200, 100) -- ส้ม
    else
        color = Color3.fromRGB(255, 100, 100) -- แดง
    end
    
    createTween(timerLabel, TweenInfo.new(0.3, Enum.EasingStyle.Quad), 
        {TextColor3 = color}):Play()
end

-- ฟังก์ชันแสดงสถานะ
local function setStatus(text, color)
    statusLabel.Text = text
    statusLabel.TextColor3 = color or Color3.fromRGB(200, 200, 200)
end

-- ฟังก์ชันทำ teleport
local function attemptTeleport()
    setStatus("Teleporting...", Color3.fromRGB(100, 255, 100))
    timerLabel.Text = "00:00"
    
    -- สร้าง loading animation
    task.spawn(function()
        for i = 1, 3 do
            timerLabel.Text = "Teleporting" .. string.rep(".", i)
            task.wait(0.3)
        end
    end)
    
    local success, err = pcall(function()
        TeleportService:Teleport(PLACE_ID, player)
    end)
    
    if not success then
        warn("Teleport failed:", err)
        setStatus("Teleport failed! Retrying...", Color3.fromRGB(255, 100, 100))
        timerLabel.Text = "ERROR"
        timerLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        
        -- Shake animation เมื่อ error
        local shake = createTween(mainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear), 
            {Position = UDim2.new(1, -305, 0, 20)})
        shake:Play()
        shake.Completed:Connect(function()
            createTween(mainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear), 
                {Position = UDim2.new(1, -295, 0, 20)}):Play()
            task.wait(0.1)
            createTween(mainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear), 
                {Position = UDim2.new(1, -300, 0, 20)}):Play()
        end)
        
        task.wait(RETRY_DELAY)
        return false
    end
    return true
end

-- Event handlers
closeButton.Activated:Connect(function()
    local fadeOut = createTween(mainFrame, TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), 
        {Position = UDim2.new(1, -100, 0, 20), BackgroundTransparency = 1})
    fadeOut:Play()
    fadeOut.Completed:Connect(function()
        gui:Destroy()
    end)
end)

-- Main countdown loop
task.spawn(function()
    while gui.Parent do
        local remaining = WAIT_TIME
        setStatus("Next rejoin in:", Color3.fromRGB(200, 200, 200))
        timerLabel.Text = formatTime(remaining) -- อัปเดต timer เริ่มต้น
        updateTimerColor(remaining, WAIT_TIME) -- อัปเดตสีเริ่มต้น
        updateProgress(0, WAIT_TIME) -- รีเซ็ต progress bar
        
        while remaining > 0 and gui.Parent do
            timerLabel.Text = formatTime(remaining)
            updateProgress(WAIT_TIME - remaining, WAIT_TIME)
            updateTimerColor(remaining, WAIT_TIME)
            
            task.wait(1)
            remaining -= 1
        end
        
        if gui.Parent then
            local success = attemptTeleport()
            if not success then
                -- Reset และเริ่มใหม่
                updateProgress(0, WAIT_TIME)
            else
                break -- ออกจาก loop หาก teleport สำเร็จ
            end
        end
    end
end)
