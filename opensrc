-- Rejoin Script with External Configuration Support
-- Usage: 
-- local TIME_LOOP_COUNTER_MAX = 130
-- loadstring(game:HttpGet("https://raw.githubusercontent.com/tigerprettyboi/rejoiner/refs/heads/main/opensrc"))()

local Players = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- ===== CONFIG SYSTEM =====
-- รับค่า config จากตัวแปร global หรือใช้ค่า default
local Config = {
    -- เวลารอก่อน rejoin (วินาที)
    waitTime = getgenv().TIME_LOOP_COUNTER_MAX or _G.TIME_LOOP_COUNTER_MAX or 120,
    
    -- Place ID (ถ้าไม่กำหนดจะใช้ place ปัจจุบัน)
    placeId = getgenv().PLACE_ID or _G.PLACE_ID or game.PlaceId,
    
    -- เวลาก่อน retry เมื่อ teleport ล้มเหลว
    retryDelay = getgenv().RETRY_DELAY or _G.RETRY_DELAY or 3,
    
    -- UI Settings
    guiName = getgenv().GUI_NAME or _G.GUI_NAME or "RejoinUI",
    showCloseButton = getgenv().SHOW_CLOSE_BUTTON or _G.SHOW_CLOSE_BUTTON or true,
    showProgressBar = getgenv().SHOW_PROGRESS_BAR or _G.SHOW_PROGRESS_BAR or true,
    
    -- Colors
    primaryColor = getgenv().PRIMARY_COLOR or _G.PRIMARY_COLOR or Color3.fromRGB(100, 200, 255),
    backgroundColor = getgenv().BACKGROUND_COLOR or _G.BACKGROUND_COLOR or Color3.fromRGB(25, 25, 30),
    textColor = getgenv().TEXT_COLOR or _G.TEXT_COLOR or Color3.fromRGB(255, 255, 255)
}

-- แสดง config ที่ใช้งาน
print("=== Rejoin Script Config ===")
print("Wait Time:", Config.waitTime, "seconds")
print("Place ID:", Config.placeId)
print("Retry Delay:", Config.retryDelay, "seconds")
print("GUI Name:", Config.guiName)
print("===========================")

-- ===== GUI CREATION =====
local gui = Instance.new("ScreenGui")
gui.Name = Config.guiName .. "_" .. tostring(math.random(1000, 9999))
gui.ResetOnSpawn = false
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.Parent = player:WaitForChild("PlayerGui")

-- Main frame
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 280, 0, 120)
mainFrame.Position = UDim2.new(1, -300, 0, 20)
mainFrame.BackgroundColor3 = Config.backgroundColor
mainFrame.BorderSizePixel = 0
mainFrame.Parent = gui

-- Corner radius
local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 12)
corner.Parent = mainFrame

-- Gradient background
local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Config.backgroundColor:lerp(Color3.new(1,1,1), 0.1)),
    ColorSequenceKeypoint.new(1, Config.backgroundColor:lerp(Color3.new(0,0,0), 0.1))
}
gradient.Rotation = 45
gradient.Parent = mainFrame

-- Border stroke
local stroke = Instance.new("UIStroke")
stroke.Color = Config.primaryColor
stroke.Thickness = 1
stroke.Transparency = 0.7
stroke.Parent = mainFrame

-- Icon
local icon = Instance.new("ImageLabel")
icon.Size = UDim2.new(0, 24, 0, 24)
icon.Position = UDim2.new(0, 15, 0, 15)
icon.BackgroundTransparency = 1
icon.Image = "rbxasset://textures/ui/GuiImagePlaceholder.png"
icon.ImageColor3 = Config.primaryColor
icon.Parent = mainFrame

-- Title
local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -50, 0, 25)
title.Position = UDim2.new(0, 45, 0, 15)
title.BackgroundTransparency = 1
title.Text = "Auto Rejoin"
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextColor3 = Config.textColor
title.TextXAlignment = Enum.TextXAlignment.Left
title.Parent = mainFrame

-- Status label
local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(1, -20, 0, 18)
statusLabel.Position = UDim2.new(0, 10, 0, 42)
statusLabel.BackgroundTransparency = 1
statusLabel.Text = "Next rejoin in:"
statusLabel.Font = Enum.Font.Gotham
statusLabel.TextSize = 12
statusLabel.TextColor3 = Config.textColor:lerp(Color3.new(0.5,0.5,0.5), 0.3)
statusLabel.TextXAlignment = Enum.TextXAlignment.Center
statusLabel.Parent = mainFrame

-- Timer label
local timerLabel = Instance.new("TextLabel")
timerLabel.Size = UDim2.new(1, -20, 0, 35)
timerLabel.Position = UDim2.new(0, 10, 0, 60)
timerLabel.BackgroundTransparency = 1
timerLabel.Text = "00:00"
timerLabel.Font = Enum.Font.GothamBlack
timerLabel.TextSize = 28
timerLabel.TextColor3 = Config.primaryColor
timerLabel.TextXAlignment = Enum.TextXAlignment.Center
timerLabel.Parent = mainFrame

-- Progress bar (แสดงเฉพาะเมื่อ config อนุญาต)
local progressBg, progressFill
if Config.showProgressBar then
    progressBg = Instance.new("Frame")
    progressBg.Size = UDim2.new(1, -20, 0, 3)
    progressBg.Position = UDim2.new(0, 10, 1, -15)
    progressBg.BackgroundColor3 = Config.backgroundColor:lerp(Color3.new(1,1,1), 0.1)
    progressBg.BorderSizePixel = 0
    progressBg.Parent = mainFrame

    local progressBgCorner = Instance.new("UICorner")
    progressBgCorner.CornerRadius = UDim.new(0, 2)
    progressBgCorner.Parent = progressBg

    progressFill = Instance.new("Frame")
    progressFill.Size = UDim2.new(1, 0, 1, 0)
    progressFill.Position = UDim2.new(0, 0, 0, 0)
    progressFill.BackgroundColor3 = Config.primaryColor
    progressFill.BorderSizePixel = 0
    progressFill.Parent = progressBg

    local progressFillCorner = Instance.new("UICorner")
    progressFillCorner.CornerRadius = UDim.new(0, 2)
    progressFillCorner.Parent = progressFill
end

-- Close button (แสดงเฉพาะเมื่อ config อนุญาต)
local closeButton
if Config.showCloseButton then
    closeButton = Instance.new("TextButton")
    closeButton.Size = UDim2.new(0, 20, 0, 20)
    closeButton.Position = UDim2.new(1, -25, 0, 5)
    closeButton.BackgroundTransparency = 1
    closeButton.Text = "×"
    closeButton.Font = Enum.Font.GothamBold
    closeButton.TextSize = 16
    closeButton.TextColor3 = Config.textColor:lerp(Color3.new(0.5,0.5,0.5), 0.3)
    closeButton.Parent = mainFrame
end

-- ===== ANIMATION FUNCTIONS =====
local function createTween(object, info, properties)
    return TweenService:Create(object, info, properties)
end

-- Slide in animation
local slideIn = createTween(mainFrame, 
    TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), 
    {Position = UDim2.new(1, -300, 0, 20)})
slideIn:Play()

-- ===== UTILITY FUNCTIONS =====
local function formatTime(seconds)
    local minutes = math.floor(seconds / 60)
    local secs = seconds % 60
    return string.format("%02d:%02d", minutes, secs)
end

local function updateProgress(current, total)
    if Config.showProgressBar and progressFill then
        local progress = current / total
        createTween(progressFill, TweenInfo.new(0.2, Enum.EasingStyle.Quad), 
            {Size = UDim2.new(progress, 0, 1, 0)}):Play()
    end
end

local function updateTimerColor(remaining, total)
    local ratio = remaining / total
    local color
    
    if ratio > 0.5 then
        color = Config.primaryColor
    elseif ratio > 0.25 then
        color = Config.primaryColor:lerp(Color3.fromRGB(255, 200, 100), 0.7)
    else
        color = Color3.fromRGB(255, 100, 100)
    end
    
    createTween(timerLabel, TweenInfo.new(0.3, Enum.EasingStyle.Quad), 
        {TextColor3 = color}):Play()
end

local function setStatus(text, color)
    statusLabel.Text = text
    if color then
        statusLabel.TextColor3 = color
    end
end

local function attemptTeleport()
    setStatus("Teleporting...", Color3.fromRGB(100, 255, 100))
    timerLabel.Text = "00:00"
    
    -- Loading animation
    task.spawn(function()
        for i = 1, 3 do
            if gui.Parent then
                timerLabel.Text = "Teleporting" .. string.rep(".", i)
                task.wait(0.3)
            end
        end
    end)
    
    local success, error = pcall(function()
        TeleportService:Teleport(Config.placeId, player)
    end)
    
    if not success then
        warn("[Rejoin Script] Teleport failed:", error)
        setStatus("Teleport failed! Retrying...", Color3.fromRGB(255, 100, 100))
        timerLabel.Text = "ERROR"
        timerLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
        
        -- Shake animation on error
        local shake1 = createTween(mainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear), 
            {Position = UDim2.new(1, -305, 0, 20)})
        shake1:Play()
        shake1.Completed:Connect(function()
            local shake2 = createTween(mainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear), 
                {Position = UDim2.new(1, -295, 0, 20)})
            shake2:Play()
            shake2.Completed:Connect(function()
                createTween(mainFrame, TweenInfo.new(0.1, Enum.EasingStyle.Linear), 
                    {Position = UDim2.new(1, -300, 0, 20)}):Play()
            end)
        end)
        
        task.wait(Config.retryDelay)
        return false
    end
    return true
end

-- ===== EVENT HANDLERS =====
if Config.showCloseButton and closeButton then
    closeButton.Activated:Connect(function()
        local fadeOut = createTween(mainFrame, 
            TweenInfo.new(0.3, Enum.EasingStyle.Back, Enum.EasingDirection.In), 
            {Position = UDim2.new(1, -100, 0, 20), BackgroundTransparency = 1})
        fadeOut:Play()
        fadeOut.Completed:Connect(function()
            gui:Destroy()
        end)
    end)
end

-- ===== MAIN COUNTDOWN LOOP =====
print("[Rejoin Script] Starting countdown...")
task.spawn(function()
    while gui.Parent do
        local remaining = Config.waitTime
        setStatus("Next rejoin in:")
        print("[Rejoin Script] Starting new cycle with", remaining, "seconds")
        
        while remaining > 0 and gui.Parent do
            timerLabel.Text = formatTime(remaining)
            updateProgress(Config.waitTime - remaining, Config.waitTime)
            updateTimerColor(remaining, Config.waitTime)
            
            print("[Rejoin Script] Time remaining:", remaining) -- Debug
            task.wait(1)
            remaining = remaining - 1
        end
        
        if gui.Parent then
            print("[Rejoin Script] Attempting teleport...")
            local success = attemptTeleport()
            if not success then
                -- Reset progress bar และเริ่มใหม่
                updateProgress(0, Config.waitTime)
                setStatus("Retrying in " .. Config.retryDelay .. " seconds...", Color3.fromRGB(255, 200, 100))
                print("[Rejoin Script] Teleport failed, will retry...")
            else
                print("[Rejoin Script] Teleport successful!")
                break -- ออกจาก loop หาก teleport สำเร็จ
            end
        end
    end
end)

-- แจ้งว่า script โหลดเสร็จแล้ว
print("[Rejoin Script] Successfully loaded with " .. Config.waitTime .. " seconds timer!")

-- ===== CLEANUP =====
-- ทำลาย GUI เมื่อ player ออกจากเกม
player.AncestryChanged:Connect(function()
    if not player.Parent then
        if gui and gui.Parent then
            gui:Destroy()
        end
    end
end)
